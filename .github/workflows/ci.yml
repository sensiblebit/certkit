name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: read

jobs:
  # ── PR Conventions ─────────────────────────────────

  pr-title:
    name: PR Title
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: amannn/action-semantic-pull-request@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert

  branch-name:
    name: Branch Name
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Check branch naming convention
        run: python3 scripts/checks.py branch-name "${{ github.head_ref }}"

  commit-messages:
    name: Commit Messages
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Check commit messages
        run: python3 scripts/checks.py commit-message --ci "origin/${{ github.base_ref }}"

  verified-commits:
    name: Verified Commits
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Check all commits are verified
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: python3 scripts/checks.py verified-commits "${{ github.repository }}" "${{ github.event.pull_request.number }}"

  # ── Go ──────────────────────────────────────────────

  go-build:
    name: Go Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version: stable
          check-latest: true
          cache: true
      - run: go build -trimpath ./...

  go-vet:
    name: Go Vet
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version: stable
          check-latest: true
          cache: true
      - run: go vet ./...

  go-test:
    name: Go Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version: stable
          check-latest: true
          cache: true
      - run: go test -race -count=1 ./...

  golangci-lint:
    name: Lint (golangci-lint)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version: stable
          check-latest: true
          cache: true
      - uses: golangci/golangci-lint-action@v9
        with:
          version: latest

  goimports:
    name: Lint (goimports)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version: stable
          check-latest: true
          cache: true
      - name: Check goimports
        run: python3 scripts/checks.py goimports

  govulncheck:
    name: Vulnerability Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version: stable
          check-latest: true
          cache: true
      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest
      - name: Run govulncheck
        run: govulncheck ./...

  # ── WASM ────────────────────────────────────────────

  wasm:
    name: WASM Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version: stable
          check-latest: true
          cache: true
      - name: Vet + Build (WASM)
        run: python3 scripts/checks.py wasm

  # ── Web (JS/TS) ────────────────────────────────────

  web-test:
    name: Web Tests (vitest)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: lts/*
          cache: npm
          cache-dependency-path: web/package-lock.json
      - run: npm ci
      - run: npm test

  web-lint:
    name: Web Lint (prettier)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: lts/*
      - name: Check formatting
        run: npx prettier@latest --check 'web/**/*.{js,ts,css,html}' '!web/public/wasm_exec.js'

  wrangler-build:
    name: Wrangler Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: lts/*
          cache: npm
          cache-dependency-path: web/package-lock.json
      - run: npm ci
      - name: Build Cloudflare Functions
        run: npx wrangler pages functions build --outdir /tmp/certkit-fn-check

  # ── Markdown ────────────────────────────────────────

  markdownlint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: lts/*
      - name: Run markdownlint
        run: npx markdownlint-cli@0.47.0 --config .markdownlint.yaml '**/*.md'

  # ── Gate ────────────────────────────────────────────

  ci-ok:
    name: CI
    if: always()
    needs:
      - pr-title
      - branch-name
      - commit-messages
      - verified-commits
      - go-build
      - go-vet
      - go-test
      - golangci-lint
      - goimports
      - govulncheck
      - wasm
      - web-test
      - web-lint
      - wrangler-build
      - markdownlint
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          results="${{ join(needs.*.result, ' ') }}"
          for r in $results; do
            if [ "$r" != "success" ] && [ "$r" != "skipped" ]; then
              echo "One or more jobs failed: $results"
              exit 1
            fi
          done
          echo "All checks passed"
