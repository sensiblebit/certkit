name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: read

jobs:
  # ── Org-wide reusable workflows ───────────────────────

  pr-conventions:
    if: github.event_name == 'pull_request'
    uses: sensiblebit/.github/.github/workflows/pr-conventions.yml@main

  go-ci:
    uses: sensiblebit/.github/.github/workflows/go-ci.yml@main

  # ── Project-specific ──────────────────────────────────

  wasm:
    name: WASM Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version: stable
          check-latest: true
          cache: true
      - name: Vet + Build (WASM)
        run: |
          GOOS=js GOARCH=wasm go vet ./cmd/wasm/
          GOOS=js GOARCH=wasm go build -o /dev/null ./cmd/wasm/

  web:
    name: Web
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: lts/*
          cache: npm
          cache-dependency-path: web/package-lock.json
      - run: npm ci
      - name: Run tests
        id: test
        run: npm test
      - name: Build Cloudflare Functions
        if: success() || failure()
        run: npx wrangler pages functions build --outdir /tmp/certkit-fn-check

  lint:
    uses: sensiblebit/.github/.github/workflows/lint.yml@main
    with:
      prettier_paths: "web/**/*.{js,ts,css,html}"
      prettier_exclude: "!web/public/wasm_exec.js"

  # ── Gate ──────────────────────────────────────────────

  ci-ok:
    name: CI
    if: always()
    needs:
      - pr-conventions
      - go-ci
      - wasm
      - web
      - lint
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          results="${{ join(needs.*.result, ' ') }}"
          for r in $results; do
            if [ "$r" != "success" ] && [ "$r" != "skipped" ]; then
              echo "One or more jobs failed: $results"
              exit 1
            fi
          done
          echo "All checks passed"
